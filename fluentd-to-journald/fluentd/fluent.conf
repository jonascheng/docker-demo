<source>
  @type  forward
  @label @mainstream
  port  24224
</source>

<label @mainstream>
  <match nginx/**>
    @type relabel
    @label @nginx
  </match>

  <match zaplogger/**>
    @type relabel
    @label @zaplogger
  </match>

  # fall back no match
  <match **>
    @type stdout
  </match>
</label>

# route for nginx severity tagging
<label @nginx>
  <filter>
    @type parser
    format nginx
    key_name log
    reserve_data true
  </filter>

  # rank severity
  <match nginx/**>
    @type rewrite_tag_filter
    <rule>
      key code
      pattern /^2\d\d$/
      tag info.${tag}
    </rule>
    <rule>
      key code
      pattern /^(3\d\d|4\d\d)$/
      tag error.${tag}
    </rule>
    # default treat as fatal if uncatch
    <rule>
      key code
      pattern /.+/
      tag fatal.${tag}
    </rule>
  </match>

  <match **>
    @type relabel
    @label @severity_control
  </match>
</label>

# route for zaplogger severity tagging
<label @zaplogger>
  <filter>
    @type parser
    format json
    key_name log
    reserve_data true
  </filter>

  # rank severity
  <match zaplogger/**>
    @type rewrite_tag_filter
    <rule>
      key level
      pattern /^warn$/
      tag warn.${tag}
    </rule>
    <rule>
      key level
      pattern /^error$/
      tag error.${tag}
    </rule>
    # default treat as info if uncatch
    <rule>
      key level
      pattern /.+/
      tag info.${tag}
    </rule>
  </match>

  <match **>
    @type relabel
    @label @severity_control
  </match>
</label>

# route for serverity control
<label @severity_control>
  # insert tag into log record for later filter
  <filter **>
    @type record_transformer
    <record>
      tag ${tag}
    </record>
  </filter>

  # filter desired log according to tag field
  <filter **>
    @type grep
    <regexp>
      key tag
      pattern "#{ENV['SEVERITY']}"
    </regexp>
  </filter>

  # route to output
  <match **>
    @type relabel
    @label @output
  </match>
</label>

<label @output>
  # only keey log field
  <filter **>
    @type record_transformer
    renew_record true
    keep_keys log
  </filter>

  <match **>
    @type file
    path /fluentd/log/docker.*.log
    append true
    time_slice_format %Y%m%d
    time_slice_wait 1m
    time_format %Y%m%dT%H%M%S%z
  </match>
</label>

# fall back no match
<match **>
  @type stdout
</match>
